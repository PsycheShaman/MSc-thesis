---
title: "Final thesis plots and fixes"
author: "Gerhard Viljoen"
date: "05/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list=ls())
load("C:/Users/Gerhard/Documents/msc-thesis-data/aux_.rdata")
load("C:/Users/Gerhard/Documents/msc-thesis-data/meta.rdata")
load("C:/Users/Gerhard/Documents/msc-thesis-data/y.rdata")
```


```{r}
names(aux)
names(meta)
```

```{r}
require(ggplot2)
require(latex2exp)

aux$dEdX <- as.numeric(aux$dEdX)
aux$P <- as.numeric(aux$P)

dedx_plot <- data.frame(cbind(aux$P,aux$dEdX))

names(dedx_plot) <- c("P","dEdX")

dedx_plot$`Particle ID` <- factor(ifelse(y==1,"electron","pion"))

# levels(dedx_plot$`Particle ID`) <- c(electron=TeX("$\\textit{e}$"),pion=TeX("$\\textit{\\pi}$"))

particle_names = list("electron" = TeX("$\\textit{e}$"), "pion" = TeX("$\\textit{\\pi}$"))

particle_labeler <- function(variable,value){
  return(particle_names[value])
}                    

require(ggExtra)   

x = hist(dedx_plot$P,breaks = 0:100)
x = x$mids
y = hist(dedx_plot$P,breaks=0:100)
y = y$mids

#install.packages("viridis")  # Install
require("viridis") 


ggplot(dedx_plot[(as.character(dedx_plot$`Particle ID`)=="electron"&dedx_plot$P>=1.5)|(as.character(dedx_plot$`Particle ID`)=="pion"&dedx_plot$P>=2),],aes(P,dEdX))+geom_hex(bins=1000)+facet_wrap(~`Particle ID`,labeller = particle_labeler)+
  theme( axis.title.y =element_text(size=12,  family="serif"))+
  theme( axis.title.x =element_text(size=12,  family="serif"))+theme(axis.text = element_text(color = "black"))+
  theme(panel.background = element_rect(fill="white",color="black",size=0.01))+
  theme(panel.grid.major = element_line(size = 0.1, linetype = 'solid',colour = "gray90"))+
  theme(panel.grid.minor = element_line(size = 0.1, linetype = 'dashed',colour = "gray90"))+xlab(TeX("$\\textit{p}\\,(GeV/\\textit{c})$"))+
  ylab(TeX("$\\frac{d\\textit{E}}{d\\textit{x}}\\,$ ( TPC signal , arb. units )"))+ 
       theme(strip.text.x = element_text(size = 12, family = "serif"))+
  scale_fill_viridis()+theme(legend.position = c(0.9, 0.7),
                                                           legend.title = element_text(size=12,  family="serif"))

p <- ggplot(dedx_plot[(as.character(dedx_plot$`Particle ID`)=="electron"&dedx_plot$P>=1.5)|(as.character(dedx_plot$`Particle ID`)=="pion"&dedx_plot$P>=2),],aes(P,dEdX))+geom_point()+geom_density_2d()+facet_wrap(~`Particle ID`,labeller = particle_labeler)+
  theme( axis.title.y =element_text(size=12,  family="serif"))+
  theme( axis.title.x =element_text(size=12,  family="serif"))+theme(axis.text = element_text(color = "black"))+
  theme(panel.background = element_rect(fill="white",color="black",size=0.01))+
  theme(panel.grid.major = element_line(size = 0.1, linetype = 'solid',colour = "gray90"))+
  theme(panel.grid.minor = element_line(size = 0.1, linetype = 'dashed',colour = "gray90"))+xlab(TeX("$\\textit{p}\\,(GeV/\\textit{c})$"))+
  ylab(TeX("$\\frac{d\\textit{E}}{d\\textit{x}}\\,$ ( TPC signal , arb. units )"))+ 
       theme(strip.text.x = element_text(size = 12, family = "serif"))+
  scale_fill_viridis()+theme(legend.position = c(0.9, 0.7),
                                                           legend.title = element_text(size=12,  family="serif"))

p
```


```{r}
y <- data.frame(y)
pt_pid <- data.frame(cbind(aux$P,aux$PT,ifelse(y$y==0,"pion","electron")))
head(pt_pid)
pt_pid$X1 <- as.numeric(as.character(pt_pid$X1))
pt_pid$X2 <- as.numeric(as.character(pt_pid$X2))
pt_pid$X3 <- as.factor(unlist(pt_pid$X3))
names(pt_pid) <- c("P","Pt","Particle ID")
```

```{r}
n = 6
h1 <- hist(pt_pid$Pt[as.character(pt_pid$`Particle ID`)=="electron"],breaks=n)
           # breaks = c(1.5,2.5,3.5,4.5,5.5,6.5))
h2 <- hist(pt_pid$Pt[as.character(pt_pid$`Particle ID`)=="pion"],breaks=n)
           # breaks=c(1.5,2.5,3.5,4.5,5.5,6.5))

h1$mids==h2$mids

x_elec = h1$mids
x_pion = h2$mids

y_elec = h1$counts
y_pion = h2$counts

df1 <- data.frame(cbind(x_elec,y_elec))
df2 <- data.frame(cbind(x_pion,y_pion))

names(df1) <- names(df2) <- c("Pt","counts")

df <- rbind(df1,df2)
df$`Particle ID` <- c(rep("electron",length(x_elec)),rep("pion",length(x_pion)))

require(ggplot2)
require(latex2exp)

fancy_scientific <- function(l) {
     l <- format(l, scientific = TRUE)
     l <- gsub("^(.*)e", "'\\1'e", l)
     l <- gsub("e", "%*%10^", l)
     parse(text=l)
}

require(extrafont)
# font_import()
# loadfonts(device = "win")

# windowsFonts()
require(MASS)
require(scales)

breaks <- 10^(1:7)
minor_breaks <- rep(1:9, 21)*(10^rep(1:7, each=9))

ggplot(data=df,aes(x=Pt,y=counts,color=`Particle ID`))+xlab(TeX("$\\textit{p}_T (GeV/\\textit{c})$"))+geom_point()+
scale_y_continuous(trans='log10',labels = fancy_scientific,limits=c(10^0, 10^7),breaks = breaks, minor_breaks = minor_breaks)+
  theme( axis.title.x =element_text(size=12,  family="serif"))+ylab(TeX("N"))+
  theme( axis.title.y =element_text(size=12,  family="serif"))+geom_errorbar(ymin=df$counts+
                                                                               sqrt(df$counts),
                                                                             ymax=df$counts-sqrt(df$counts))+
  geom_errorbarh(aes(xmin=df$Pt-0.5,xmax=df$Pt+0.5))+theme(legend.position = c(0.9, 0.85),legend.text = 
                                                             element_text(size=12,  family="serif"),
                                                           legend.title = element_text(size=12,  family="serif"))+ theme( axis.line = element_line(colour = "black", 
                      size = 0.5, linetype = "solid"))+theme(axis.text = element_text(color = "black"))+
  theme(panel.background = element_rect(fill="white",color="black",size=0.01))+
  theme(panel.grid.major = element_line(size = 0.1, linetype = 'solid',colour = "gray90"))+
  theme(panel.grid.minor = element_line(size = 0.1, linetype = 'dashed',colour = "gray90"))+
  theme(legend.box.background = element_rect(colour = "black"),
        legend.background = element_blank(),legend.key = element_blank())+
  annotation_logticks(base=10,sides = "l")
  
```

```{r}

# scale_y_log10() geom_step()+ +geom_point()

breaks <- c(1,2,3,4,5,7,10,15,20)
# minor_breaks <- rep(0:2, 21)*(10^rep(0:2, each=9))

ggplot(data=data.frame(cbind(h1$mids,h2$counts/h1$counts)),aes(x=h1$mids,y=h2$counts/h1$counts))+geom_point()+
  ggtitle(element_blank())+xlab(TeX("\\textit{p}_T (GeV/\\textit{c})"))+ylab(TeX('Relative $\\,\\pi$ abundance: $\\,\\,(\\,\\frac{N_{\\pi}}{N_e}\\,)$'))+scale_y_continuous(trans='log10',limits=c(.1, 30),breaks=breaks)+
  geom_errorbar(aes(ymin=(h2$counts/h1$counts)-sqrt(h2$counts/h1$counts),ymax=(h2$counts/h1$counts)+sqrt(h2$counts/h1$counts),width=.05))+
  geom_errorbarh(aes(xmin=h1$mids-0.5,xmax=h1$mids+0.5))+
  theme( axis.title.x =element_text(size=12,  family="serif"))+
  theme( axis.title.y =element_text(size=12,  family="serif"))+
  theme(panel.grid.major = element_line(size = 0.1, linetype = 'solid',colour = "gray90"))+
  theme(panel.grid.minor = element_line(size = 0.1, linetype = 'dashed',colour = "gray90"))+ theme( axis.line = element_line(colour = "black", 
                      size = 0.5, linetype = "solid"))+theme(axis.text = element_text(color = "black"))+
  theme(panel.background = element_rect(fill="white",color="black",size=0.01))

```

```{r}
rm(list=ls())
load("C:/Users/Gerhard/Documents/msc-thesis-data/y.rdata")
load("C:/Users/Gerhard/Documents/msc-thesis-data/x.rdata")
dim(x) <- c(6573905,17,24)
ph <- apply(x, 1, colSums)

ph_elec_mean <- colMeans(t(ph)[which(y==1),])
ph_pi_mean <- colMeans(t(ph)[which(y==0),])
ph <- cbind(c(ph_elec_mean,ph_pi_mean),rep(c(1,0),each=24))
ph <- setNames(data.frame(ph),c("Pulse height (mV)","Particle ID")) 
ph$`Particle ID` <- factor(ifelse(ph$`Particle ID`==1,"electron","pion"))


ph$`Drift time (us)` <- seq(from=0,to=2.4,length.out=24)

require(ggplot2)

require(latex2exp)

ggplot(ph,aes(x=`Drift time (us)`,y=`Pulse height (mV)`,color=`Particle ID`))+geom_line()+geom_point()+xlim(c(0,2.8))+
  xlab(TeX("Drift time ($\\mu$s)"))+ylab(TeX("Average pulse height$\\,\\,\\,\\,(mV)$"))+
  theme( axis.title.x =element_text(size=12,  family="serif"))+
  theme( axis.title.y =element_text(size=12,  family="serif"))+
  theme(panel.grid.major = element_line(size = 0.1, linetype = 'solid',colour = "gray90"))+
  theme(panel.grid.minor = element_line(size = 0.1, linetype = 'dashed',colour = "gray90"))+ theme( axis.line = element_line(colour = "black", 
                      size = 0.5, linetype = "solid"))+theme(axis.text = element_text(color = "black"))+
  theme(panel.background = element_rect(fill="white",color="black",size=0.02,linetype = "solid"))+
  theme(legend.box.background = element_rect(colour = "black",linetype = "solid"),
        legend.background = element_blank(),legend.key = element_blank())+theme(legend.position = c(0.85, 0.86),legend.text = 
                                                             element_text(size=12,  family="serif"),
                                                           legend.title = element_text(size=12,  family="serif"))+
  scale_y_continuous(breaks =seq(0,200,by=10),limits = c(0,200))+scale_x_continuous(breaks = 0.2*0:12)
```


```{r}
rm(list=ls())
```

```{r}
# d <- read.csv("C:/Users/gerhard/Documents/Msc-thesis/Code/statistical_analysis/Networks Compared.csv",sep=";",header=T)
```


```{r}
rm(list=ls())
dat <- read.csv("C:/Users/gerhard/Documents/Msc-thesis/Code/statistical_analysis/Pion_efficiency_results_incremental_training.csv",sep=";",header=T)

require(dplyr)

dat <- tribble(
  ~P, ~pi_eff_unseen, ~pi_eff_seen,
  1.5, NA, 0.012,
  2.5, 0.014,0.0112,
  3.5, 0.0116,0.0151,
  4.5,NA,NA,
  5.5,NA,NA)

require(reshape2)

dat <- melt(dat,id.vars = "P")

require(ggplot2)

ggplot(dat,aes(P,value,color=variable))+geom_point()+
  geom_errorbarh(xmin=dat$P-0.5,xmax=dat$P+0.5)

#TODO: get plot data from publication

```

```{r}
# detach("package:MASS", unload=TRUE)
rm(list=ls())
d <- read.csv("C:/Users/gerhard/Documents/Msc-thesis/Code/statistical_analysis/Networks Compared.csv",sep=";",header=T)

names(d)

d$Convolutional[d$Convolutional]

require(dplyr)

pi_eff_by_num_dense_layers <- d %>%
  subset(is.na(Convolutional)==T) %>%
  dplyr::select(Model.Number,Layer.Number,Pion.Efficiency) %>%
  group_by(Model.Number) %>%
  mutate(num_layers=n())

head(pi_eff_by_num_dense_layers)

pi_eff_by_num_dense_layers <- unique(pi_eff_by_num_dense_layers)

pi_eff_by_num_dense_layers <- pi_eff_by_num_dense_layers[,-c(1,2)]

#pi_eff_by_num_dense_layers <- pi_eff_by_num_dense_layers[-289,]

pi_eff_by_num_dense_layers$Pion.Efficiency <- as.character(pi_eff_by_num_dense_layers$Pion.Efficiency )

require(stringr)

head(d)

pi_eff_by_num_convolutional_layers <- d %>%
  subset(Convolutional==T) %>%
  dplyr::select(Model.Number,Layer.Number,Pion.Efficiency) %>%
  group_by(Model.Number) %>%
  mutate(num_layers=n())

pi_eff_by_num_convolutional_layers$Pion.Efficiency <- as.numeric(str_replace(string=as.character(pi_eff_by_num_convolutional_layers$Pion.Efficiency),pattern=",",replacement="."))

pi_eff_by_num_convolutional_layers <- unique(pi_eff_by_num_convolutional_layers)

pi_eff_by_num_convolutional_layers <- pi_eff_by_num_convolutional_layers[,-c(1,2)]

#pi_eff_by_num_convolutional_layers <- pi_eff_by_num_convolutional_layers[-289,]

pi_eff_by_num_convolutional_layers$Pion.Efficiency <- as.character(pi_eff_by_num_convolutional_layers$Pion.Efficiency )

require(stringr)

pi_eff_by_num_convolutional_layers$Pion.Efficiency <- as.numeric(str_replace(string=as.character(pi_eff_by_num_convolutional_layers$Pion.Efficiency),pattern=",",replacement="."))

pi_eff_by_num_dense_layers$Pion.Efficiency <- as.numeric(str_replace(string=as.character(pi_eff_by_num_dense_layers$Pion.Efficiency),pattern=",",replacement="."))

pi_eff_by_num_convolutional_layers$layer_type <- as.factor("Convolutional")
pi_eff_by_num_dense_layers$layer_type <- as.factor("Dense")

pi_eff_by_num_dense_layers <- rbind(pi_eff_by_num_dense_layers,pi_eff_by_num_convolutional_layers)

require(ggplot2)
require(latex2exp)

fancy_scientific <- function(l) {
     l <- format(l, scientific = TRUE)
     l <- gsub("^(.*)e", "'\\1'e", l)
     l <- gsub("e", "%*%10^", l)
     parse(text=l)
}

# require(scales)

pi_eff_by_num_dense_layers$Pion.Efficiency <- as.numeric(as.character(pi_eff_by_num_dense_layers$Pion.Efficiency))

# pi_eff_by_num_dense_layers <- as.numeric(as.character(pi_eff_by_num_dense_layers))
# 
# pi_eff_by_num_dense_layers <- data.frame(pi_eff_by_num_dense_layers)

names(pi_eff_by_num_dense_layers)[3] <- "Layer Type"

ggplot(pi_eff_by_num_dense_layers,aes(num_layers,Pion.Efficiency,col=`Layer Type`))+ geom_point()+
  theme(panel.background = element_blank())+theme(panel.grid.major = element_line(size = 0.1, linetype = 'solid',colour = "gray90"))+
  theme(panel.grid.minor = element_line(size = 0.1, linetype = 'dashed',colour = "gray90"))+ theme( axis.line = element_line(colour = "black", 
                      size = 0.5, linetype = "solid"))+theme(axis.text = element_text(color = "black"))+
  theme(panel.background = element_rect(fill="white",color="black",size=0.02,linetype = "solid"))+
  theme(legend.box.background = element_rect(colour = "black",linetype = "solid"))+
  scale_y_continuous(trans="log10",breaks =c(0.001,0.01,0.1*c(0,1,2,3,4,5,7,10)),minor_breaks =c(0.002,0.003,0.004,0.005,0.006,0.007,0.008,0.009,0.02,0.03,0.04,0.05,0.06,0.07,0.08,0.09,0.6,0.8,0.9,0.45,0.35,0.25,0.11,
                                                                                                 0.12,0.13,0.14,0.15,0.16,0.17,0.18,0.19,0.9),labels = fancy_scientific,limits = c(0.001,1))+
  theme( axis.title.x =element_text(size=12,  family="serif"))+
  theme( axis.title.y =element_text(size=12,  family="serif"))+
  ylab(
    TeX("$\\epsilon_{\\pi}$")
  )+
  xlab(TeX("$N_{layers}$"))+facet_wrap(~`Layer Type`,scales="free_x")+
  theme(legend.box.background = element_rect(colour = "black",linetype = "solid"),
        legend.background = element_blank(),legend.key = element_blank())+theme(legend.position = c(0.89, 0.86),legend.text = 
                                                             element_text(size=12,  family="serif"),
                                                           legend.title = element_text(size=12,  family="serif"))+ 
       theme(strip.text.x = element_text(size = 12, family = "serif"))+theme(legend.title = element_text(size=12,  family="serif"))+ theme(legend.position = "none")

```


```{r}
names(d)

require(plotly)

p_3d <- d %>%
  dplyr::select(Model.Number,Learning.Rate,Epochs,Pion.Efficiency,Optimizer,Batch.Size,Layer.Number,Convolutional) %>%
  group_by(Model.Number) %>%
  mutate(convolutional_layers=length(which(Convolutional))) %>%
  mutate(`Total N layers`=max(Layer.Number)) %>%
  unique() %>%
  na.omit() %>%
  data.frame()

p_3d <- p_3d[,-c(1,7,8)]

require(stringr)

p_3d <- data.frame(p_3d)

p_3d$Learning.Rate <- as.numeric(str_replace(string=as.character(p_3d$Learning.Rate),pattern = ",","."))
p_3d$Pion.Efficiency <- as.numeric(str_replace(string=as.character(p_3d$Pion.Efficiency),pattern = ",","."))

p_3d <- unique(p_3d)

# p_3d <- expand.grid(p_3d)

require(ggExtra)

# p <- ggplot(p_3d,aes(x=Epochs,y=Learning.Rate,color=Batch.Size))+geom_jitter()+scale_y_continuous(trans='log10')+
#   scale_fill_distiller(palette=4, direction=-1) 
# 
# ggMarginal(p,type="density")
# p <-ggMarginal(p,type="density")
# min(p_3d$Pion.Efficiency)


# pi_eff_by_num_convolutional_layers <- unique(pi_eff_by_num_convolutional_layers)
# p_3d <- unique(p_3d)

p_3d$Learning.Rate <- as.character(p_3d$Learning.Rate)

    

# particle_names = list("0.01" = TeX("10^{-1}"),"1e-05"=TeX("10^{-5}"), "1e-07"= TeX("10^{-7}"),"1e-06"=TeX("10^{-6}"))
# 
# particle_labeler <- function(variable,value){
#   return(particle_names[value])
# }

p_3d$Learning.Rate <- as.factor(p_3d$Learning.Rate)

# levels(p_3d$Learning.Rate) <- c("0.01" = TeX("$\\eta=10^{-1}$"),"1e-05"=TeX("$\\eta=10^{-5}$"),"1e-06"= TeX("$\\eta=10^{-6}$"),"1e-07"= TeX("$\\eta=10^{-7}$"))

# levels(p_3d$Learning.Rate) <- c("0.01" = TeX("$\\eta=0.01$"),"1e-05"=TeX("$\\eta=0.000001$"),"1e-06"= TeX("$\\eta=0.0000001$"),"1e-07"= TeX("$\\eta=0.00000001$"))

levels(p_3d$Learning.Rate) <- c("0.01" = "eta==~10^-2","1e-05"="eta==~10^-5","1e-06"= "eta==~10^-6","1e-07"= "eta==~10^-7")

as.character(p_3d$Learning.Rate)

p_3d$Batch.Size <- as.factor(p_3d$Batch.Size)

names(p_3d)[c(6,7)] <- c("Number of conv. layers","Total number of layers")

ggplot(p_3d,aes(x=Epochs,y=Pion.Efficiency,size=`Total number of layers`,shape=Optimizer,color=`Number of conv. layers`))+geom_jitter(alpha=6/10)+facet_wrap(~factor(Learning.Rate),labeller = label_parsed)+
  theme(panel.background = element_blank())+theme(panel.grid.major = element_line(size = 0.1, linetype = 'solid',colour = "gray90"))+
  theme(panel.grid.minor = element_line(size = 0.1, linetype = 'dashed',colour = "gray90"))+ theme( axis.line = element_line(colour = "black", 
                      size = 0.5, linetype = "solid"))+theme(axis.text = element_text(color = "black"))+
  theme(panel.background = element_rect(fill="white",color="black",size=0.02,linetype = "solid"))+
  ylab(expression(epsilon[pi]))+xlab("Epochs")+
  theme( axis.title.x =element_text(size=12,  family="serif"))+
  theme( axis.title.y =element_text(size=12,  family="serif"))+
  scale_y_continuous(trans="log10",breaks =c(0.001,0.01,0.1*c(0,1,2,5,7,10)),labels = fancy_scientific,limits = c(0.01,1))+
  theme(legend.box.background = element_rect(colour = "black",linetype = "solid"),
        legend.background = element_blank(),legend.key = element_blank())+theme(legend.text = 
                                                             element_text(size=12,  family="serif"),
                                                           legend.title = element_text(size=12,  family="serif"))

#+scale_y_continuous(trans='log10')

```




```{r}
mydata = data.frame(x=rnorm(4), y=runif(4), tau=c(0,0,1,1))
ggplot(mydata) + geom_point(aes(x=x, y=y)) +
         facet_grid(~ tau,labeller = label_bquote(tau ^ .(x)))

labNames <- c('xLab','yLab')
xlab <- bquote(.(labNames[1]) ~ x^2)
ylab <- bquote(.(labNames[2]) ~ y^2)
plot(c(1:10), xlab = xlab, ylab = ylab)
```

```{r}
rm(list=ls())

load("C:/Users/gerhard/documents/msc-thesis/Thesis/misc/random_images/geant_preds.rdata")

length(sim_preds)

hist(sim_preds,breaks=1000)
```



#Real V Geant

```{r}
rm(list=ls())

load("c:/Users/gerhard/Documents/msc-thesis-data/hijing-sim/sim_x_full.rdata")
load("c:/Users/gerhard/Documents/msc-thesis-data/hijing-sim/real_x_full.rdata")
```

```{r}
require(abind)
x_train = abind(real_x,sim_x,along=1)

y_train = c(rep(1,dim(real_x)[1]),rep(0,dim(sim_x)[1]))

dim(x_train) = c(dim(x_train),1)

require(keras)
model <- keras_model_sequential() %>%
  layer_conv_2d(16, kernel_size = c(4,4),activation = "tanh") %>%
  layer_max_pooling_2d() %>%
  layer_conv_2d(32, kernel_size = c(4,4),activation = "tanh") %>%
  layer_max_pooling_2d() %>%
  layer_flatten() %>%
  layer_dense(512,"tanh") %>%
  layer_dense(256,"tanh") %>%
  layer_dense(128,"tanh") %>%
  layer_dense(1, "sigmoid")

model %>%
  compile(
    loss="binary_crossentropy",
    optimizer_adam(0.00001),
    metrics="acc"
    
  )
  
history <- model %>%
  fit(x_train,
      y_train,
      batch_size=32,
      verbose=2,
      epochs=30,
      shuffle=TRUE)

png("C:/Users/gerhard/documents/MSc-thesis/NEW/ML/geant_v_real_FINAL.png")
plot(history)
dev.off()
```


```{r}
m <- setNames(data.frame(cbind(1:history$params$epochs, history$metrics$loss, history$metrics$acc)),c("epochs","loss","accuracy")) 
```



```{r}
require(ggplot2)

require(reshape2)

m <- melt(m,id.vars ="epochs")

ggplot(m,aes(x=epochs,y=value,color=variable))+geom_line()+geom_point()+facet_wrap(~variable)+scale_y_continuous(limits=c(0,1))
```


```{r}
preds <- data.frame(cbind(predict(model,x_train)),ifelse(y_train==1,"real","geant"))

require(ggplot2)

names(preds) <- c("P(real)","Datatype")

preds$`P(real)` <- as.numeric(as.character(preds$`P(real)`))

preds$Datatype <- as.factor(preds$Datatype)

fancy_scientific <- function(l) {
     l <- format(l, scientific = TRUE)
     l <- gsub("^(.*)e", "'\\1'e", l)
     l <- gsub("e", "%*%10^", l)
     parse(text=l)
}

require(dplyr)

ggplot(preds,aes(x=preds$`P(real)`,fill=Datatype,colour=Datatype))+geom_bar(stat="bin", position = position_dodge())+
  xlab("P(real)")+scale_y_continuous(trans="log",labels = fancy_scientific)+
  theme(panel.background = element_blank())+theme(panel.grid.major = element_line(size = 0.1, linetype = 'solid',colour = "gray90"))+
  theme(panel.grid.minor = element_line(size = 0.1, linetype = 'dashed',colour = "gray90"))+ theme( axis.line = element_line(colour = "black", 
                      size = 0.5, linetype = "solid"))+theme(axis.text = element_text(color = "black"))+
  theme(panel.background = element_rect(fill="white",color="black",size=0.02,linetype = "solid"))+
  theme( axis.title.x =element_text(size=12,  family="serif"))+
  theme( axis.title.y =element_text(size=12,  family="serif"))+
  theme(legend.box.background = element_rect(colour = "black",linetype = "solid"),
        legend.background = element_blank(),legend.key = element_blank())+theme(legend.text = 
                                                             element_text(size=12,  family="serif"),
                                                           legend.title = element_text(size=12,  family="serif"),
                                                           legend.position = c(0.7,0.85))
```


```{r}
baseurl <- "C:/Users/gerhard/documents/Msc-thesis/code/"
NN <- data.frame(read.csv(paste0(baseurl,"NN.csv"),header = F))
LQ7D <- data.frame(read.csv(paste0(baseurl,"LQ7D.csv"),header = F))

NN$V2 > LQ7D$V2

LQ3D <- data.frame(read.csv(paste0(baseurl,"LQ3D.csv"),header = F))
LQ2D <- data.frame(read.csv(paste0(baseurl,"LQ2D.csv"),header = F))
LQ1D <- data.frame(read.csv(paste0(baseurl,"LQ1D.csv"),header = F))
TruncMean <- data.frame(read.csv(paste0(baseurl,"Trunc Mean.csv"),header = F))

myResult <- tribble(
  ~GeV, ~pi_eff_unseen, ~pi_eff_seen,
  1.5, NA, 0.012,
  2.5, 0.014,0.0112,
  3.5, 0.0116,0.0151,
  4.5,NA,NA,
  5.5,NA,NA)

names(myResult) <- c("GeV","This thesis: unseen","This thesis: seen")

myResult$GeV <- as.numeric(as.character(myResult$GeV))

myResult <- melt(myResult,id.vars = "GeV")

names(myResult) <- c("GeV","model","pi_efficiency")

names(NN) <- c("GeV","pi_efficiency")
names(LQ7D) <- c("GeV","pi_efficiency")
names(LQ3D) <- c("GeV","pi_efficiency")
names(LQ2D) <- c("GeV","pi_efficiency")
names(LQ1D) <- c("GeV","pi_efficiency")
names(TruncMean) <- c("GeV","pi_efficiency")

NN$model <- "NN"
LQ7D$model <- "LQ7D"
LQ3D$model <- "LQ3D"
LQ2D$model <- "LQ2D"
LQ1D$model <- "LQ1D"
TruncMean$model <- "Truncated Mean"

myResult <- myResult[-c(1,4,5,9,10),]

myResult$GeV <- as.numeric(as.character(myResult$GeV))
myResult$pi_efficiency <- as.numeric(as.character(myResult$pi_efficiency))
myResult$model <- as.character(myResult$model)

NN$GeV <- as.numeric(as.character(NN$GeV))
NN$pi_efficiency <- as.numeric(as.character(NN$pi_efficiency))
NN$model <- as.character(NN$model)

LQ7D$GeV <- as.numeric(as.character(LQ7D$GeV))
LQ7D$pi_efficiency <- as.numeric(as.character(LQ7D$pi_efficiency))
LQ7D$model <- as.character(LQ7D$model)

NN$pi_efficiency > LQ7D$pi_efficiency

LQ3D$GeV <- as.numeric(as.character(LQ3D$GeV))
LQ3D$pi_efficiency <- as.numeric(as.character(LQ3D$pi_efficiency))
LQ3D$model <- as.character(LQ3D$model)

LQ2D$GeV <- as.numeric(as.character(LQ2D$GeV))
LQ2D$pi_efficiency <- as.numeric(as.character(LQ2D$pi_efficiency))
LQ2D$model <- as.character(LQ2D$model)

LQ1D$GeV <- as.numeric(as.character(LQ1D$GeV))
LQ1D$pi_efficiency <- as.numeric(as.character(LQ1D$pi_efficiency))
LQ1D$model <- as.character(LQ1D$model)

TruncMean$GeV <- as.numeric(as.character(TruncMean$GeV))
TruncMean$pi_efficiency <- as.numeric(as.character(TruncMean$pi_efficiency))
TruncMean$model <- as.character(TruncMean$model)

TruncMean$GeV[length(TruncMean$GeV)] <- 4.6
LQ1D$GeV[length(LQ1D$GeV)] <- 4.6

res <- data.frame(rbind(myResult,
                        NN,
             LQ7D,
             LQ3D,
             LQ2D,
             LQ1D,
             TruncMean))

add <- res[1:5,]

xmin = c(
res$GeV[1:5]-0.5,
res$GeV[6:65]-c(
  
  c(0.2,
                0.1,
                0.1,
                0.1,
                0.1,
                0.2,
                0.2,
                0.25,
                0.25),
  
  c(0.2,
                0.1,
                0.1,
                0.1,
                0.1,
                0.2,
                0.2,
                0.25,
                0.25),
  
  c(0.2,
                0.1,
                0.1,
                0.1,
                0.1,
                0.2,
                0.2,
                0.25,
                0.25,
    0.35),
  
  c(0.2,
                0.1,
                0.1,
                0.1,
                0.1,
                0.2,
                0.2,
                0.25,
                0.25,
    0.35),
  
  c(0.2,
                0.1,
                0.1,
                0.1,
                0.1,
                0.2,
                0.2,
                0.25,
                0.25,
    0.35,
    0.6),
  
    c(0.2,
                0.1,
                0.1,
                0.1,
                0.1,
                0.2,
                0.2,
                0.25,
                0.25,
    0.35,
    0.6)
                
                
                )
  
)


xmax = c(
res$GeV[1:5]+0.5,
res$GeV[6:65]+c(
  
  c(0.2,
                0.1,
                0.1,
                0.1,
                0.1,
                0.2,
                0.2,
                0.25,
                0.25),
  
  c(0.2,
                0.1,
                0.1,
                0.1,
                0.1,
                0.2,
                0.2,
                0.25,
                0.25),
  
  c(0.2,
                0.1,
                0.1,
                0.1,
                0.1,
                0.2,
                0.2,
                0.25,
                0.25,
    0.35),
  
  c(0.2,
                0.1,
                0.1,
                0.1,
                0.1,
                0.2,
                0.2,
                0.25,
                0.25,
    0.35),
  
  c(0.2,
                0.1,
                0.1,
                0.1,
                0.1,
                0.2,
                0.2,
                0.25,
                0.25,
    0.35,
    1.4),
  
    c(0.2,
                0.1,
                0.1,
                0.1,
                0.1,
                0.2,
                0.2,
                0.25,
                0.25,
    0.35,
    1.4)
                
                
                )
  
)


res$pi_efficiency <- round(res$pi_efficiency,4)

res$GeV <- round(res$GeV,1)
# res$GeV[nrow(res)] <- 4.6

require(latex2exp)

ggplot(res,aes(x=GeV,y=pi_efficiency,color=model))+geom_point()+scale_y_continuous(trans="log10",
                                                                                   limits = c(10^-3,10^1),
                                                                                   labels = fancy_scientific)+
  geom_point(data=add,aes(x=add$GeV,y=add$pi_efficiency,size=5,alpha=0.8))+geom_errorbarh(xmin=xmin,xmax=xmax)+
  scale_x_continuous(limits=c(0,6))+scale_alpha(guide=F)+scale_size(guide=F)+
  theme(panel.background = element_blank())+theme(panel.grid.major = element_line(size = 0.1, linetype = 'solid',colour = "gray90"))+
  theme(panel.grid.minor = element_line(size = 0.1, linetype = 'dashed',colour = "gray90"))+ theme( axis.line = element_line(colour = "black", 
                      size = 0.5, linetype = "solid"))+theme(axis.text = element_text(color = "black"))+
  theme(panel.background = element_rect(fill="white",color="black",size=0.02,linetype = "solid"))+
  ylab(expression(epsilon[pi]))+xlab(TeX("$\\textit{p}\\,(GeV/\\textit{c})$"))+
  theme( axis.title.x =element_text(size=12,  family="serif"))+
  theme( axis.title.y =element_text(size=12,  family="serif"))+theme(legend.position = c(0.8, 0.79),
                                                           legend.title = element_blank(),
                                                           legend.text = element_text(size=8,family = "serif"),
                                                           legend.background = element_rect(colour = "black"))+
  annotation_logticks(base=10,side="lr")+guides(color=guide_legend(ncol=2))

# +scale_alpha_manual(values=c("This thesis: seen"=1, "This thesis: unseen"="1", 
                                                                # "NN"="0.5","LQ7D"="0.5","LQ3D"="0.5","LQ1D"="0.5","Truncated Mean"="0.5"))
```


```{r}
# install.packages('digitize') #download the digitize package
library(digitize) #load the digitize package into the workspace
```


```{r}
# cal = ReadAndCal("C:/Users/gerhard/documents/msc-thesis/thesis/misc/random_images/trd_res.png")
```






































