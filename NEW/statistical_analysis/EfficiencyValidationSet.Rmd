---
title: "Independent Test Set Validation"
author: "Gerhard Viljoen"
date: "07/08/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list=ls())
for(model in c(paste0("model",c(1:4,10:15,21:23)))){
  print("--------------------------------------------------------------------------------------------------")
  print(model)
  print("--------------------------------------------------------------------------------------------------")

pred <- read.csv(paste0("C:/Users/gerhard/Documents/hpc-mini/final/",model,"_results.csv"),header=F)
act <- read.csv(paste0("C:/Users/gerhard/Documents/hpc-mini/final/",model,"_y_test.csv"),header=F)

names(pred) <- "pred"
names(act) <- "act"

pred_act <- data.frame(cbind(pred,act))

pred_act$pred <- (pred_act$pred)

pi <- which(pred_act$act==1)
el <- which(pred_act$act!=1)

while(length(pi)%%6!=0){
  #print(length(pi))
  pi <- pi[-length(pi)]
  
}

while(length(el)%%6!=0){
  #print(length(el))
  el <- el[-length(el)]
  
}

pred_act <- pred_act[c(el,pi),]

six_tracklet_pred <- c()

for(i in seq(1,nrow(pred),6)){
  j=i+5
  
  this.dat <- prod(pred[i:j,])/sum(prod(pred[i:j,]),prod(1-pred[i:j,]))
  six_tracklet_pred <- c(six_tracklet_pred,this.dat)
}

six_tracklet_pred <- data.frame(six_tracklet_pred)

six_tracklet_pred <- na.omit(six_tracklet_pred)

six_tracklet_real <- c()

for(i in seq(1,nrow(act),6)){
  this.dat <- act[i,]
  six_tracklet_real <- c(six_tracklet_real,this.dat)
  
}

six_tracklet_real <- data.frame(six_tracklet_real)

which(is.na(six_tracklet_real))

pred_act <- data.frame(cbind(six_tracklet_pred,six_tracklet_real))

elec_pi_eff_func <- function(model_1.preds,model_1.labels){
  
    # model_1.preds <- read.csv(model_1.preds,header=F, sep="")
    # 
    # model_1.labels <- read.csv(model_1.labels,header=F, sep="")
    
    model_1 <- data.frame(cbind(model_1.preds,model_1.labels))
    
    model_1.electrons <- which(model_1[,2]==1)
    
    electrons <- model_1[model_1.electrons,]
    
    pions <- model_1[-as.numeric(model_1.electrons),]
    
    electrons <- data.frame(electrons)
    
    names(electrons) <- c("prediction","label")
    
    pions <- data.frame(pions)
    
    names(pions) <- c("prediction","label")
    
    electron_efficiency <- function(electrons.,par){
  
    electrons <- electrons.
    
    electrons$electron_pred <- ifelse(electrons$prediction>=par[1],1,0)
    
    correct <- ifelse(electrons$electron_pred==electrons$label,1,0)
    
    error_metric <- sum(correct)/nrow(electrons)
    
    error_metric <- (error_metric-0.9)^2
    
    return(error_metric)
  
}

  res <- optim(par=c(0),fn=electron_efficiency,lower = 0,upper = 1,electrons.=electrons,method="Brent")
  
  require(ggplot2)
  
  g <- ggplot(pred_act,aes(pred_act[,1],colour=factor(pred_act[,2])))+geom_histogram(bins = 1000)+facet_wrap(factor(pred_act[,2]))
  print(g)
  
  hist(pred_act[,1],breaks=1000)
  abline(v=res$par,col="red")
  
  electrons$predicted_label <- ifelse(electrons$prediction>=res$par,1,0)
  
  print(paste0("Electron Efficiency: ",sum(electrons$predicted_label)/nrow(electrons)))
  
  pions$predicted_label <- ifelse(pions$prediction>=res$par,1,0)
  
  pions$misclassified_as_electron <- ifelse(pions$predicted_label==1,1,0)
  
  print(paste0("Pion Efficiency: ",(sum(pions$misclassified_as_electron)/nrow(pions))^6))
  
  pred_act$final_pred <- ifelse(pred_act[,1]>=res$par,1,0)
  
  require(caret)
  
  print(caret::confusionMatrix(data=factor(pred_act$final_pred),reference = factor(pred_act[,2])))
  print("--------------------------------------------------------------------------------------------------")
  
}

elec_pi_eff_func(pred_act[,1],pred_act[,2])

}
```


# Load previous model 25's

```{r}
require(keras)

model <- load_model_hdf5("C:\\Users\\Gerhard\\Documents\\hpc-mini\\chamber_gain_corrected\\model25_1_3.h5")

# library(deepviz)
# library(magrittr)
# 
# model %>% plot_model()
# 
# weights <- get_weights(model)
# 
# par(mfrow=c(4,4),mar = rep(1, 4),bg="black")
# 
# 
# 
# for(i in 1:16){
#   image(weights[[1]][,,1,i],axes=F,col=gray.colors(100),useRaster = T)
#   
# }
# 
# 
# par(mfrow=c(1,1),mar=c(10,1,10,1))
# 
# image(as.matrix(weights[[2]]),axes=F,col=gray.colors(100),useRaster = T)


```

```{r}
rm(pred,act,pred_act,six_tracklet_pred,six_tracklet_real,weights,pi,el)

load("C:/Users/gerhard/Documents/msc-thesis-data/x_265420.rdata")
load("C:/Users/gerhard/Documents/msc-thesis-data/y_265420.rdata")


dim(x_265420) <- c(dim(x_265420),1)

preds <- model %>%
  predict(x_265420)
```


```{r}
pred_act <- data.frame(cbind(preds,y_265420))

elec_pi_eff_func(pred_act[,1],pred_act[,2])
```

```{r}
barplot(table(y_265420))
```



```{r}
process <- function(f){
  print("function: process()")
  
  require(jsonlite)
  
  print("read in file")
  j <- fromJSON(f)
  
  # print("extract momentum")
  # P <- sapply(j, `[[`,"P")
  # 
  # P <- as.numeric(P)
  # 
  # print("cut on momentum")
  # keep <- which(P>=2&P<4)
  # 
  # dont_keep <- 1:length(P)
  # 
  # dont_keep <- dont_keep[-keep]
  
  print("layer 0 no pad data")
  l <- sapply(j, `[[`,"layer 0")
  
  if(is.null(l)){
    break()
  }else{
    
    n <- as.numeric(which(sapply(l,is.null)))
    d <- which(as.vector(sapply(l, typeof))!="integer")
    
  }
  

  
  print("layer 1 no pad data") 
  l <- sapply(j, `[[`,"layer 1")
  
  if(is.null(l)){
    break()
  }else{
    n <- c(n,as.numeric(which(sapply(l,is.null))))
    d <- c(d,which(as.vector(sapply(l, typeof))!="integer"))
  }
  

  
  print("layer 2 no pad data")
  l <- sapply(j, `[[`,"layer 2")
  
  if(is.null(l)){
    break()
  }else{
  n <- c(n,as.numeric(which(sapply(l,is.null))))
  d <- c(d,which(as.vector(sapply(l, typeof))!="integer"))
  }
  
  
  print("layer 3 no pad data")
  l <- sapply(j, `[[`,"layer 3")
  
  if(is.null(l)){
    break()
  }else{
  n <- c(n,as.numeric(which(sapply(l,is.null))))
  d <- c(d,which(as.vector(sapply(l, typeof))!="integer"))
  }
  
  print("layer 4 no pad data")
  l <- sapply(j, `[[`,"layer 4")
  
  if(is.null(l)){
    break()
  }else{
  
  n <- c(n,as.numeric(which(sapply(l,is.null))))
  d <- c(d,which(as.vector(sapply(l, typeof))!="integer"))
  }
  
  print("layer 5 no pad data")
  l <- sapply(j, `[[`,"layer 5")
  
  if(is.null(l)){
    break()
  }else{
  
  n <- c(n,as.numeric(which(sapply(l,is.null))))
  d <- c(d,which(as.vector(sapply(l, typeof))!="integer"))
  }
  
  dont_keep <- c(n,d)
  
  print("remove no pad data")
  j <- j[-dont_keep]
  
  return(j)
  
}
```


```{r}
rm(x_265420,y_265420)
files <- list.files(path=paste0("C:/Users/gerhard/Documents/msc-thesis-data/processed/000",265342),
                      pattern="*json",
                      full.names=T,
                      recursive=TRUE)
  
  j <- process(files[1])
  
  for(i in 2:length(files)){
    print(paste0("FILE: ",i))
    
    f <- process(files[i])
    j <- c(j,f)
  }
```

```{r}
pdg <- sapply(j,`[[`,"pdgCode")
layer0 <- sapply(j,`[[`,"layer 0")
```

```{r}
layer0 <- layer0/653.6152

dim(layer0) <- c(dim(layer0)[2],17,24,1)

layer0 <- layer0/max(layer0)

preds <- model %>%
  predict(layer0)

pred_act <- data.frame(cbind(preds,ifelse(abs(pdg)==11,1,0)))


elec_pi_eff_func(pred_act[,1],pred_act[,2])
```



```{r}
model <- load_model_hdf5("C:\\Users\\Gerhard\\Documents\\hpc-mini\\final\\model4_.h5")

preds <- model %>%
  predict(layer0)

pred_act <- data.frame(cbind(preds,ifelse(abs(pdg)==11,1,0)))


elec_pi_eff_func(pred_act[,1],pred_act[,2])

```





```{r}
barplot(table(pred_act[,2]))

barplot(table(ifelse(pred_act[,1]>=0.5,1,0)))
```























